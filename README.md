# decompose_insar_velocities
"decompose_insar_velocities" (DIV) is an open-source set of matlab scripts for performing a velocity decomposition (e.g. Watson et al. 2022, and references therein) on multiple overlapping InSAR velocity fields.
The code has been written to use InSAR LOS velocities generated by LiCSBAS (https://github.com/yumorishita/LiCSBAS), using interferograms from the COMET-LiCS project (https://comet.nerc.ac.uk/COMET-LiCS-portal/), although any LOS velocities may be used if they are correctly formatted as geotifs.

Written for Matlab 2020a and should work with all newer versions.
For older versions, the main change is replacing `tiledlayout` with `subplot`.

This is research code provided to you "as is" with no warranties of correctness.

Andrew Watson, 2022

*Watson, A. R., Elliott, J. R., & Walters, R. J. (2022). Interseismic Strain Accumulation Across the Main Recent Fault, SW Iran, From Sentinel‐1 InSAR Observations. Journal of Geophysical Research: Solid Earth, 127(2), e2021JB022674.*

---

## Example

The *example* directory contains velocities for four frames (two ascending and two descending) over the North Anatolian Fault in Turkey.
These have been generated at 1 km resolution using LiCSBAS.
To run the tutorial after cloning/downloading this repository, simply run `decompose_insar_velocities('example/north_anatolian_fault.conf')` in the Matlab command window with the main repository directory set as your path.

---

## Processing stages
DIV works through the following processing steps, many of which can be altered using within the config file.

1. Read the input parameter file that defines how the rest of the script will function.
2. Load the line-of-sight velocities, uncertainties, and look vector components for all frames. These are stored in a Matlab cell array, as the dimensions may vary. Optionally, also load a mask, interpolated GNSS velocities, and fault and border polygons for plotting.
3. Check and downsample the look vector components if required.
4. Optionally perform additional downsampling of all inputs.
5. Optionally scale the velocity uncertainties using a semivariogram to mitigate the impact of the reference point (Ou et al. 2022).
6. Interpolate inputs onto a common grid, required so that we can perform calculations using data from multiple inputs.
7. Optionally merge adajcent frames along-track. If adjacent frames do not overlap, either because they are spatially seperated or because of masking, then the track will be split into two subtracks.
8. Optionally correct for the "reference frame effect" (Stephenson et al. 2022), which can produce velocity ramps in the range direction. Requires ITRF2014 plate velocities in No-Net-Rotation. These can be generated using the Unavco Plate Motion Calculator (https://www.unavco.org/software/geodetic-utilities/plate-motion-calculator/plate-motion-calculator.html).
9. Shift the relative los-of-sight InSAR velocities into a common reference frame, by tying them to GNSS velocities. This is required to perform the decomposition.
10. Optionally generate frame overlap statistics, useful for assessing noise in the InSAR velocities.
11. Perform the velocity decomposition to estimate East and Vertical velocities.
12. Optionally plot and save outputs. 

*Ou, Q., Daout, S., Weiss, J. R., Shen, L., Lazecký, M., Wright, T. J., & Parsons, B. E. (2022). Large‐Scale Interseismic Strain Mapping of the NE Tibetan Plateau From Sentinel‐1 Interferometry. Journal of Geophysical Research: Solid Earth, 127(6), e2022JB024176.*


*Stephenson, O. L., Liu, Y. K., Yunjun, Z., Simons, M., & Rosen, P. (2022). The Impact of Plate Motions on Long-Wavelength InSAR-Derived Velocity Fields. Unpublished.*

---

## Config file
The example config file provides short descriptions of each option. Below, we give greater details:

### para_cores
The number of parallel processes to run for the decomposition, which is performed pixel-by-pixel.

### ties2gnss
Shift relative InSAR velocities into a common reference frame defined by a network of GNSS velocities (e.g. relative -> Eurasia-fixed).
This is performed by calculating the residual between the interpolated East and North GNSS velocities projected into the line-of-sight of each frame, and the InSAR line-of-sight velocities.
We extract the long-wavelength signals from the residual, and subtract these from each frame.
Two methods for handling the residuals are currently included:
 - 0 - disables the referencing.
 - 1 - fit a 2nd order polynomial surface to the residual (based on Weiss et al. 2020).
 - 2 - apply a gaussian filter to the residuals (based on Xu et al. 2021).

### ds_factor and ds_method
Applies downsampling to the input velocities, taking either the mean or the median of a given window size (ds_factor x ds_factor).
This can improve the computational requirements of later steps (useful for testing).

### usemask
Using pre-masked velocities can lead to smearing or shrinking of the masked area if additional downsapling is performed within DIV.
Hence, we recommend providing unmasked velocities and a matching mask file, which is then optionally applied after both regridding and downsampling.

### merge_tracks_along
Merge overlapping frames within each track.
This requires that the frame directories have been given in order for each track.
Options are:
 - 0 - disables.
 - 1 - apply the shift to each frame, but leave the frames seperate (i.e. don't take the mean to fully merge them).
 - 2 - take the mean of overlapping points, combining multiple frames into a single array.

### merge_tracks_along_func
Function used to perform the track merging. This is what is fit to the overlapping pixels and then removed to perform the "merge".
 - 0 - scalar offset
 - 1 - first order polynomial plane (c, x, y)

### merge_tracks_across
Merge adjacent tracks into a continuous velocity field.
This is an experimental method which is useful for comparing velocities with and without GNSS referencing.
The LOS velocities for each track are projected into a fixed average LOS, and then the difference is minimised with a static offset.
Finally, we take the mean of the overlap.
Options are:
 - 0 - disables
 - 1 - enables

### plate_motion
Apply a correction for the "reference frame bias" caused by absolute rigid plate motions in an ITRF reference frame.
The "relative" LOS velocities produce by e.g. LiCSBAS are technically in the reference frame of the satellite orbit, which is ITRF.
This means that any rigid translation of a plate (i.e. not the deformation that we want to measure) will be captured.
While this velocity tends to be nearly constant across the area of a frame, the varying LOS makes it appear as a ramp in the range direction.
For more details see "https://www.essoar.org/doi/10.1002/essoar.10511538.1".
We can mitigate this bias by taking rigid no-net-rotation plate velocities in ITRF (see the UNAVCO plate motion calculator) and projecting them into LOS.
Options are:
 - 0 - disables
 - 1 - enables

### condG_threshold
This is a threshold on the value of cond(G), where G is the design matrix for the velocity decomposition.
As long as the decomposition is ran for pixels with at least one ascending and descending frame (which is currently forced), then a poorly conditioned G is unlikely to be a problem.
Options are:
 - 0 - disables
 - ~0 - enables with that value

### var_threshold
Threshold on the model variance (see Qm), that removes pixels for which either the East or Vertical variances are above the given value.
Useful for removing particularly noisy pixels.
Options are:
 - 0 - disables
 - ~0 - enables with that value

### frame_overlaps
Calculate histograms of the differences between overlapping frames, both along and across track.
For across-track frames, we project the velocities into a shared LOS.
This is a useful test for quantifying the effectiveness of both the along-track merge and the GNSS referencing.
Options are:
 - 0 - disables
 - 1 - enables

### save_geotif
Write the decomposed East, Vertical, and North velocities to geotifs, using the same projection as the inputs.
Options are:
 - 0 - disables
 - 1 - enables

### plt_faults
Plot fault traces on the decomposed velocity maps.
Options are:
 - 0 - disables
 - 1 - enables

### plt_borders
Plot country borders on the decomposed velocity maps.
Options are:
 - 0 - disables
 - 1 - enables

### plt_input_vels
Plot the input vels as a mosaic of all frames. Useful for checking that the vels have loaded in correctly.
Options are:
 - 0 - disables
 - 1 - enables

### plt_merge_tracks
Plot the merged tracks if merge_tracks_along has been set to 1 or 2.
Options are:
 - 0 - disables
 - 1 - enables

---

## Input file formats

GNSS file should be a .mat file containing structure with the following:
```
    gnss_field.x - vector of x axis coords (n)
    gnss_field.y - vector of y axis coords (m)
    gnss_field.N - grid of north gnss vels (mxn)
    gnss_field.E - grid of east gnss vels (mxn)
```
Optional extras:
```
    gnss_field.sN - grid of north 1-sigma uncertainties (mxn)
    gnss_field.sE - grid of east 1-sigma uncertainties (mxn)
```

---

## Acknowledgements

This work was created while completing a PhD at the University of Leeds, School of Earth and Environment, funded by the Royal Society.

These scripts were designed to work with outputs from LiCSBAS and LiCSAR, projects of COMET, the UK Natural Environment Research Council's Centre for the Observation and Modelling of Earthquakes, Volcanoes and Tectonics.

DIV uses open-access scientific colour maps from https://www.fabiocrameri.ch/colourmaps/ (Crameri et al. 2020), and fault traces from the GEM Active Fault Database (Styron and Pagani, 2020).

I would like to thank Jack McGrath for code advice and debugging, John Elliott for his guidance, and both Dehua Wang and Jessica Payne for their feedback as users.

Andrew Watson, 2022.

*Crameri, F., Shephard, G. E., & Heron, P. J. (2020). The misuse of colour in science communication. Nature communications, 11(1), 1-10.*

*Styron, Richard, and Marco Pagani. “The GEM Global Active Faults Database.” Earthquake Spectra, vol. 36, no. 1_suppl, Oct. 2020, pp. 160–180, doi:10.1177/8755293020944182.*
